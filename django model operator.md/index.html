<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  

  
  <title>django model operator | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="ModelORM 当和数据库通信时，会由于开发语言和数据库的数据格式不一致，导致无法直接通信，使得通信变得很繁琐 ORM是解决此问题的必要方案。 ORM – Object Relational  Mapping  对象关系映射  python对象    关系表       搭建映射 对象属性          表中的列   搭建映射 使得对象和关系表可以直接通信，极大简化通信过程  Django的">
<meta property="og:type" content="article">
<meta property="og:title" content="django model operator">
<meta property="og:url" content="http://yoursite.com/django model operator.md/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="ModelORM 当和数据库通信时，会由于开发语言和数据库的数据格式不一致，导致无法直接通信，使得通信变得很繁琐 ORM是解决此问题的必要方案。 ORM – Object Relational  Mapping  对象关系映射  python对象    关系表       搭建映射 对象属性          表中的列   搭建映射 使得对象和关系表可以直接通信，极大简化通信过程  Django的">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2019-06-07T14:50:21.925Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="django model operator">
<meta name="twitter:description" content="ModelORM 当和数据库通信时，会由于开发语言和数据库的数据格式不一致，导致无法直接通信，使得通信变得很繁琐 ORM是解决此问题的必要方案。 ORM – Object Relational  Mapping  对象关系映射  python对象    关系表       搭建映射 对象属性          表中的列   搭建映射 使得对象和关系表可以直接通信，极大简化通信过程  Django的">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-django model operator" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/django model operator.md/" class="article-date">
  <time datetime="2019-06-07T14:48:30.000Z" itemprop="datePublished">2019-06-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      django model operator
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Model"><a href="#Model" class="headerlink" title="Model"></a>Model</h1><h2 id="ORM"><a href="#ORM" class="headerlink" title="ORM"></a>ORM</h2><blockquote>
<p>当和数据库通信时，会由于开发语言和数据库的数据格式不一致，导致无法直接通信，使得通信变得很繁琐</p>
<p>ORM是解决此问题的必要方案。</p>
<p>ORM – Object Relational  Mapping  对象关系映射</p>
<ul>
<li><strong>python对象</strong>    <strong>关系表</strong>       搭建映射</li>
<li><strong>对象属性</strong>          <strong>表中的列</strong>   搭建映射</li>
<li><strong>使得对象和关系表可以直接通信，极大简化通信过程</strong></li>
</ul>
<p>Django的Model章节，也不例外的践行了ORM，为model层的开发提供可极大便利</p>
<p>Django中的ORM的搭建，核心是model类，所以Model章节的内容，将围绕model类展开</p>
</blockquote>
<h2 id="回顾：Model层开发过程"><a href="#回顾：Model层开发过程" class="headerlink" title="回顾：Model层开发过程"></a>回顾：Model层开发过程</h2><ul>
<li><p>安装数据库驱动：pip install mysqlclient</p>
</li>
<li><p>设置数据库连接参数(settings.py)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">DATABASES = &#123;</span><br><span class="line">    &apos;default&apos;: &#123;</span><br><span class="line">        &apos;ENGINE&apos;: &apos;django.db.backends.mysql&apos;,</span><br><span class="line">        &apos;NAME&apos;: &quot;db_create&quot;,</span><br><span class="line">        &quot;USER&quot;: &quot;root&quot;,</span><br><span class="line">        &quot;PASSWORD&quot;: &quot;123&quot;,</span><br><span class="line">        &quot;PORT&quot;: &quot;3306&quot;,</span><br><span class="line">        &quot;HOST&quot;: &quot;localhost&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">##settings.py中的mysql数据库的设置</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装app；设置开发模式；设置时区　</p>
</li>
<li><p>定义model类</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    name = models.CharField(max_length=<span class="number">20</span>)  <span class="comment"># varchar(20)</span></span><br><span class="line">    age = models.IntegerField()   <span class="comment"># int</span></span><br><span class="line">    birth = models.DateTimeField()  <span class="comment"># datetime</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>生成移植文件　　更好的与不同的数据库之间做数据结构的移植</p>
</li>
<li><p>执行移植文件　　生成可执行的移植文件</p>
</li>
<li><p>测试Model操作</p>
</li>
</ul>
<h2 id="model-field"><a href="#model-field" class="headerlink" title="model-field"></a>model-field</h2><ul>
<li><p>AutoField 一般不用直接使用，Model中默认的主键类型</p>
</li>
<li><p>每一个mysql表的建立都会有一个键，作为唯一的标识存在！</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Django默认给每个Model一个主键字段(如果没有自己定义的话)</span><br><span class="line">id = models.AutoField(primary_key=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>IntegerField 4字节  int</p>
</li>
<li><p>BigIntegerField  8字节   bigint</p>
</li>
<li><p>SmallIntegerField  2字节  smallint</p>
</li>
<li><p>FloatField  底层采用float类型  double  ==8字节</p>
</li>
<li><p>DecimalField(max_digits=5,decimal_places=2)  底层采用Decimal类型  decimal</p>
<p>必填：max_digits=5 #共有几位数</p>
<p>必填：decimal_places=2#其中小数位占几位</p>
</li>
<li><p>CharField(max_length=20)   varchar(20)</p>
<p>max_length是必填属性</p>
</li>
<li><p>TextField  longtext　　(不会限制字符个数的大小)</p>
</li>
<li><p>BooleanField  接收“True/False”  tinyint</p>
</li>
<li><p>NullBooleanField  接收“True/False/None”  tinyint</p>
</li>
<li><p>DateTimeField datetime(一般用来作生日的字段)</p>
</li>
<li><p>DateField  date</p>
<p>可选：auto_now=true 可做修改时间记录</p>
<p>可选：auto_now_add=True 可做首次添加时间</p>
<p>注意：以上两属性之一指定后，该字段不允许被编辑</p>
</li>
<li><p>TimeField   time</p>
</li>
<li><p>FileField    varchar</p>
</li>
<li><p>ImageField   varchar</p>
</li>
<li><p>ForeignKey(to=关系对方的类或类名或‘self’，on_delete=级联选项)==(从表使用ForeignKeye)</p>
</li>
<li><p>OneToOneFiled(to=关系对方的类或类名或‘self’，on_delete=级联选项)</p>
</li>
<li><p>ManyToManyFiled(to=关系对方的类或类名或‘self’)</p>
</li>
</ul>
<h2 id="field-options"><a href="#field-options" class="headerlink" title="field-options"></a>field-options</h2><ul>
<li><p>null   默认False,不能为空</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">name = models.CharField(max_length=<span class="number">20</span>,null=<span class="literal">True</span>) <span class="comment">#可为空</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>default  定义默认值</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">name = models.CharField(max_length=<span class="number">20</span>,default=<span class="string">"zhj9"</span>)</span><br><span class="line">age = models.IntegerField(default=<span class="number">18</span>)</span><br><span class="line">birth = models.DateTimeField(default=<span class="string">"2018-12-12"</span>)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>默认值不会作用在数据库上，而是django自己的约定，通过Model.save()时，会使用默认值</p>
</blockquote>
</li>
<li><p>primary_key</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">id = models.AutoFiled(primary_key=<span class="literal">True</span>) <span class="comment">#默认追加，不用自己定义</span></span><br><span class="line">id = models.CharField(primary_key=<span class="literal">True</span>,max_length=<span class="number">32</span>)<span class="comment">#如果需要字符串类型的ID可以自己定义</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>unique  列是否唯一</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">name = models.CharField(max_length=<span class="number">20</span>,unique=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>db_column    自定义列名，默认和field同名</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">name = models.CharField(max_length=<span class="number">20</span>,db_column=<span class="string">"name9"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>db_index   是否在列上建立索引</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">name = models.CharField(max_length=<span class="number">20</span>,db_index=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>blank  默认Flase，用于前端页面的form验证</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">note = models.CharField(max_length=<span class="number">20</span>,blank=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<p>​</p>
</li>
</ul>
<h2 id="model-meta"><a href="#model-meta" class="headerlink" title="model-meta"></a>model-meta</h2><ul>
<li><p>db_table  设置表名</p>
</li>
<li><p>ordering   设置默认的排序规则( Model.objects.all()等查询时的排序规则 )</p>
</li>
<li><p>unique_together   设置联合唯一约束</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyModel</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">   salary = models.DecimalField(...)</span><br><span class="line">   .....</span><br><span class="line">   age = models.xxx</span><br><span class="line">   name = models.xxx</span><br><span class="line">   <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span>//unique_together <span class="comment">#表示的是元组</span></span><br><span class="line">        unique_together = ((<span class="string">"salary"</span>, <span class="string">"salary2"</span>),(<span class="string">"age"</span>,<span class="string">"age2"</span>,<span class="string">"age3"</span>))</span><br><span class="line">        db_table=<span class="string">"my_user"</span></span><br><span class="line">        ordering=（<span class="string">'-age'</span>,<span class="string">'name'</span>） <span class="comment">#根据age降序排列，如果age相同，再按照name升序排列</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="Model-API-之-增删改"><a href="#Model-API-之-增删改" class="headerlink" title="Model-API 之 增删改"></a>Model-API 之 增删改</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">user = User(name=<span class="string">"zhj"</span>,age=<span class="number">18</span>,birth=datetime.now())</span><br><span class="line">user.save()</span><br><span class="line">或者</span><br><span class="line">user = User.objects.create(name=<span class="string">"zzz"</span>,age=<span class="number">19</span>,birth=datetime.now()) <span class="comment">#创建对象并保存数据，一步完成</span></span><br><span class="line"><span class="comment">##注意，save()没有返回值，create()返回保存的对象</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">User.objects.get(pk=<span class="number">3</span>).delete()</span><br><span class="line">User.objects.all().delete()</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">user = User.objects.get(pk=<span class="number">3</span>)</span><br><span class="line">user.name=<span class="string">"new_name"</span></span><br><span class="line">user.save()</span><br></pre></td></tr></table></figure>
<h2 id="Model-API-之-查询"><a href="#Model-API-之-查询" class="headerlink" title="Model-API 之 查询"></a>Model-API 之 查询</h2><h3 id="Manager-QuerySet"><a href="#Manager-QuerySet" class="headerlink" title="Manager + QuerySet"></a>Manager + QuerySet</h3><blockquote>
<p>每个Model类都会有一个属性：objects，存储一个Manager对象，用来支持查询功能。</p>
<p>Model类中的objects属性，是父类ModelBase生成的。</p>
<p>Manager中有一个方法属性，存储的是QuerySet</p>
<p>查询功能的相关方法是由QuerySet提供实现</p>
<p>User.objects==Manager()</p>
<p>User.objects.all()</p>
<p>1&gt;User(Model(ModelBase)):再User中会由ModelBase为其指派一个属性：objects=Manager()</p>
<p>2&gt;User.objects 获取的User的Manager()，Manager()中有一个属性存储了一个QuerySet</p>
<p>3&gt;User.objects.all() 调用Manager的all()方法</p>
<p>4&gt;Manager会去调用QuerySet的相关方法，完成all的查询</p>
</blockquote>
<h3 id="查询方法"><a href="#查询方法" class="headerlink" title="查询方法"></a>查询方法</h3><blockquote>
<p>如下所有查询方法都是<strong>QuerySet</strong>实现的，只不过每个Model中都会有一个Manager,Manager接受到如下方法的调用时，会去调用<strong>QuerySet</strong>的方法，最终实现数据查询。</p>
<p>所以<strong>QuerySet</strong>这个类 是查询动作的核心支撑</p>
<p>Manager的任务是管理<strong>QuerySet</strong>，即，在需要的时候去调用QuerySet的对应方法</p>
</blockquote>
<ul>
<li><p>all()   - QuerySet</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">User.objects.all() <span class="comment">#返回QuerySet,其中是所有User的数据</span></span><br><span class="line"><span class="comment">#&lt;QuerySet [&lt;User: zhj1 19 2018/12/12 00:00:00&gt;, &lt;User: zhj2 20 2018/12/12 00:00:00&gt;,...]&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>get()  - 对象</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#id=1</span></span><br><span class="line">User.objects.get(pk=<span class="number">1</span>) <span class="comment">#返回查到的数据，没有数据或数据多于1条 报错</span></span><br><span class="line"><span class="comment">#name='zhj' 而且 age=18的数据</span></span><br><span class="line">User.objects.get(name=<span class="string">"zhj"</span>,age=<span class="number">18</span>)<span class="comment">#返回查到的数据，没有数据或数据多于1条 报错</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>filter() - QuerySet</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#id=1</span></span><br><span class="line">User.objects.filter(pk=<span class="number">1</span>) <span class="comment">#返回一个QuerySet,其中是满足条件的数据</span></span><br><span class="line">User.objects.filter(name=<span class="string">'zhj'</span>,age=<span class="number">18</span>) <span class="comment">#可以有多条数据，如果没有数据，就返回一个空白的QuerySet</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>exclude() -QuerySet</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">User.objects.exclude(pk=<span class="number">1</span>) <span class="comment">#和filter相反，取不满足条件的数据，返回QuerySet</span></span><br><span class="line">User.objects.exclude(gender=<span class="literal">True</span>)<span class="comment"># True/False 或者  1/0 和bool的filed比较</span></span><br><span class="line">                            <span class="comment">#no #所有被选择出来的数据都是以列表的数据结构形式返回;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>first()  - 对象</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">User.objects.first() <span class="comment">#获取QuerySet中的第一个元素，返回一个对象或None</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>last() - 对象</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">User.objects.last() <span class="comment">#获取QuerySet中的最后一个元素，返回一个对象或None</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>exists() - Boolean</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">User.objects.exists() <span class="comment">#User对应的表中是否有数据，判断数据表是否为空。返回True/False</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>count()</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">User.objects.count() <span class="comment">#数据数量</span></span><br><span class="line">User.objects.all().count() <span class="comment">#数据数量 和上面等价</span></span><br><span class="line">User.objects.filter(age=<span class="number">18</span>).count()</span><br></pre></td></tr></table></figure>
</li>
<li><p>QuerySet使用补充</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">list(User.objects.all())  <span class="comment">#转成list</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> e <span class="keyword">in</span> User.objects.all(): <span class="comment">#可以直接遍历</span></span><br><span class="line">    print(e.age)<span class="comment">#e=User对象</span></span><br><span class="line">    print(e.name)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> User.objects.filter(name=<span class="string">"zhj"</span>):<span class="comment">#直接用于判断，QuerySet中没有数据时作为False使用</span></span><br><span class="line">   print(<span class="string">"至少有一个User数据"</span>)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="QuerySet限制操作"><a href="#QuerySet限制操作" class="headerlink" title="QuerySet限制操作"></a>QuerySet限制操作</h3><blockquote>
<p>all() , filter() , exclude() , order_by() 都会返回QuerySet对象</p>
<p>firt(),last()只能获取QuerySet对象中的头、尾元素</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">User.objects.all()[<span class="number">0</span>] <span class="comment">#返回QuerySet中第一个对象</span></span><br><span class="line">User.objects.filter(pk=<span class="number">1</span>,name=<span class="string">"zhj"</span>)[<span class="number">2</span>] <span class="comment">#返回QuerySet中第3个对象</span></span><br><span class="line"></span><br><span class="line">uname=<span class="string">"zhj"</span> <span class="comment">#可以使用变量在查询中</span></span><br><span class="line">User.objects.filter(pk=<span class="number">1</span>,name=uname)[<span class="number">2</span>] <span class="comment">#返回QuerySet中第3个对象</span></span><br><span class="line"></span><br><span class="line">User.objects.exclude(pk=<span class="number">1</span>,name=<span class="string">"zhj"</span>)[<span class="number">1</span>:<span class="number">3</span>] <span class="comment">#返回包含第[2,4)个对象(前闭后开)的新的QuerySet (子集)</span></span><br><span class="line">User.objects.exclude(pk=<span class="number">1</span>,name=<span class="string">"zhj"</span>)[:<span class="number">3</span>] <span class="comment"># 等价于[0:3]</span></span><br><span class="line">User.objects.exclude(pk=<span class="number">1</span>,name=<span class="string">"zhj"</span>)[<span class="number">2</span>:] <span class="comment"># 返回第3个到最后一个对象的新的QuerySet</span></span><br></pre></td></tr></table></figure>
<h3 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h3><ul>
<li><p>order_by</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">User.objects.all().order_by(<span class="string">"pk"</span>) <span class="comment">#根据id升序，返回QuerySet</span></span><br><span class="line">User.objects.all().order_by(<span class="string">"age"</span>)</span><br><span class="line">User.objects.all().order_by(<span class="string">"age"</span>,<span class="string">"name"</span>)</span><br><span class="line">User.objects.all().order_by(<span class="string">"age"</span>,<span class="string">"-name"</span>) <span class="comment">#根据age升序，age相同的根据name倒序</span></span><br><span class="line"></span><br><span class="line">a = <span class="string">"age"</span> <span class="comment">#使用变量</span></span><br><span class="line">User.objects.all().order_by(a,<span class="string">"name"</span>)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="条件查询"><a href="#条件查询" class="headerlink" title="条件查询"></a>条件查询</h3><blockquote>
<p>在众多查询方法中适合做条件查询的有：get()、filter()、exclude()</p>
<p>get(pk=1,name=”zhj”) 如此只是等值查询，远不能满足查询需求</p>
</blockquote>
<ul>
<li><p>比较</p>
<blockquote>
<p>不支持 “&gt; &lt; &gt;= &lt;= “这些符号，替换为关键字 lt、gt、lte、gte</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">User.objects.filter(pk__lt=<span class="number">10</span>) <span class="comment">#id小于10</span></span><br><span class="line">User.objects.get(pk__gt=<span class="number">100</span>,age__lte=<span class="number">18</span>) <span class="comment">#id大于100,age小于等于18    （两个放在一起写：就是and 且）</span></span><br><span class="line"><span class="comment">#日期比较也可以     </span></span><br><span class="line">（exclude除了满足条件之外所有）</span><br><span class="line">User.objects.exclude(birth__gte=<span class="string">"2018-5-22 12:12:12"</span>) <span class="comment">#yyyy-mm-dd HH:MM:SS格式</span></span><br><span class="line">User.objects.filter(birth__gt=datetime.now())</span><br><span class="line"></span><br><span class="line">dd = <span class="string">"2018-5-22 12:12:12"</span><span class="comment">#使用变量</span></span><br><span class="line">User.objects.exclude(birth__gte=dd) <span class="comment">#使用变量</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>模糊查询(所有带有i的表示大小写不敏感，即可以大小写通吃)</p>
<ul>
<li><p>exact、iexact (了解)</p>
</li>
<li><p>contains、icontains</p>
</li>
<li><p>startswith、istartswith</p>
</li>
<li><p>endswith、iendswith</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">User.objects.filter(name__exact=<span class="string">"ss"</span>) <span class="comment"># name等于ss</span></span><br><span class="line">User.objects.filter(name__iexact=<span class="string">"ss"</span>) <span class="comment"># 数据库本身大小写不敏感，所以 等价于exact</span></span><br><span class="line">User.objects.filter(name=<span class="string">"ss"</span>) <span class="comment">#和上面等价</span></span><br><span class="line"></span><br><span class="line">User.objects.filter(name__contains=<span class="string">"s"</span>) <span class="comment">#name中包含"s"</span></span><br><span class="line">User.objects.filter(name__icontains=<span class="string">"s"</span>) <span class="comment">#name中包含"s"或"S"</span></span><br><span class="line"></span><br><span class="line">User.objects.filter(name__startswith=<span class="string">"s"</span>)</span><br><span class="line">User.objects.filter(name__istartswith=<span class="string">"s"</span>)<span class="comment"># name是以"s"或"S"开始</span></span><br><span class="line"></span><br><span class="line">User.objects.filter(name__endswith=<span class="string">"s"</span>)</span><br><span class="line">User.objects.filter(name__iendswith=<span class="string">"s"</span>)<span class="comment"># name是以"s"或"S"结尾</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>范围</p>
<ul>
<li><p>in()　　＝＝一个可迭代对象</p>
</li>
<li><p>range()　　＝＝range(len(length)) 一个连续的整数范围内</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">User.objects.filter(name__in=(<span class="string">"zhj"</span>,<span class="string">"zz"</span>)) <span class="comment"># where name in("zhj","zz")</span></span><br><span class="line">User.objects.filter(age__in=(<span class="number">18</span>,<span class="number">19</span>,<span class="number">22</span>))</span><br><span class="line"></span><br><span class="line">User.objects.filter(age__range=(<span class="number">18</span>,<span class="number">20</span>)) <span class="comment"># where age between 18 and 20  [18,20]</span></span><br><span class="line">User.objects.filter(birth__range=(<span class="string">'2018-05-10'</span>,<span class="string">'2018-06-14'</span>))</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>日期</p>
<ul>
<li><p>year</p>
</li>
<li><p>month  </p>
</li>
<li><p>day　每月的第几天</p>
</li>
<li><p>hour</p>
</li>
<li><p>minute</p>
</li>
<li><p>second</p>
</li>
<li><p>week    一年的第几周  1-52 or 53</p>
</li>
<li><p>week_day  周几 周日=1  周六=7</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">User.objects.filter(birth__year=<span class="string">"2018"</span>)</span><br><span class="line">User.objects.filter(birth__month=<span class="string">"1"</span>) <span class="comment"># 生日是1月 可选值1-12</span></span><br><span class="line">User.objects.filter(birth__week_day__gt=<span class="number">1</span>) <span class="comment"># 生日日期大于周日</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>空值：（用来挑选某个字段是否为空值）</p>
<ul>
<li><p>isnull　　　　　　　　　</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">User.objects.filter(age__isnull=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h3 id="映射查询"><a href="#映射查询" class="headerlink" title="映射查询"></a>映射查询</h3><blockquote>
<p>select * from t_user;查询全部列</p>
<p>select id,name from t_user;查询部分列–映射查询</p>
</blockquote>
<ul>
<li><p>values()（两种方法：1.改变返回值的内部数据结构，2.查询部分列）每个元素都是一个dict对象</p>
<p>(每行都是一个dict，每个元素都是一个dict)</p>
</li>
<li><p>only()</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#values()方法的第一种用法：改变返回值的内部结构</span></span><br><span class="line">User.objects.all().values() <span class="comment">#返回所有数据的QuerySet,其中每行数据都是一个dict而不再是Model对象</span></span><br><span class="line">User.objects.values() <span class="comment">#返回所有数据的QuerySet,其中每行数据都是一个dict而不再是Model对象</span></span><br><span class="line">User.objects.filter(age__gt=<span class="number">18</span>).values() <span class="comment">#返回age&gt;18的所有数据的QuerySet,其中每行数据都是一个dict</span></span><br><span class="line"><span class="comment">#values()方法的第二种用法：查询部分列(返回QuerySet,其中每个元素都是一个dict)</span></span><br><span class="line">User.objects.all.values(<span class="string">"pk"</span>) <span class="comment">#select id from t_user;</span></span><br><span class="line">User.objects.values(<span class="string">"pk"</span>) <span class="comment">#等价上面写法：select id from t_user;</span></span><br><span class="line">User.objects.filter(age__lt=<span class="number">20</span>).values(<span class="string">"name"</span>) <span class="comment"># select name from t_user where age&lt;20</span></span><br><span class="line">User.objects.filter(name__contains=<span class="string">"zhj"</span>).values(<span class="string">"pk"</span>,<span class="string">"age"</span>)<span class="comment">#select id,age,name from  </span></span><br><span class="line"><span class="comment">#t_user where name like "%zhj%"</span></span><br><span class="line">这些queryset方法的底层实现还都是:cursor.execute(sql)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#返回&lt;QuerySet [&lt;User&gt;, &lt;User&gt;] &gt;</span></span><br><span class="line">users = User.objects.only(<span class="string">"pk"</span>,<span class="string">"name"</span>) <span class="comment">#会率先查询id和name，其他列暂时不查</span></span><br><span class="line">                                       <span class="comment">#即，QuerySet内的User中暂时只有id和name有值</span></span><br><span class="line">users[<span class="number">0</span>].age <span class="comment">#用到其他列数据时，才会查询它</span></span><br><span class="line"><span class="comment">#此处涉及到延缓查询的特性：lazy-load</span></span><br></pre></td></tr></table></figure>
<h3 id="聚合-aggregate-（返回的是一行数据）"><a href="#聚合-aggregate-（返回的是一行数据）" class="headerlink" title="聚合-aggregate （返回的是一行数据）"></a>聚合-aggregate （返回的是一行数据）</h3><ul>
<li>Avg()                       （返回的是一个字典类型的对象）</li>
<li>Count()                    （默认的值为：字段名_函数名 ： 值）</li>
<li>Max()                                                            key</li>
<li>Min()</li>
<li>Sum()</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> Count, Max,Avg,Min,Sum</span><br><span class="line"><span class="comment">#返回 &#123;'pk__max': 4, 'name__min': 'zhj'&#125;</span></span><br><span class="line">User.objects.aggregate(Max(<span class="string">"pk"</span>),Min(<span class="string">'name'</span>))<span class="comment">#selecet max(id),min(name) from t_user;</span></span><br><span class="line"><span class="comment">#可以定义别名，影响返回值结构 -- 返回 &#123;'mm': 4, 'name__min': 'zhj'&#125;</span></span><br><span class="line">User.objects.aggregate(mm = Max(<span class="string">"pk"</span>),Min(<span class="string">'name'</span>))<span class="comment">#selecet max(id) as mm,min(name) from t_user;</span></span><br></pre></td></tr></table></figure>
<h3 id="分组-annotate"><a href="#分组-annotate" class="headerlink" title="分组-annotate"></a>分组-annotate</h3><blockquote>
<p><strong>#select 分组条件列,聚合1，聚合2 from 表  group by 分组条件列</strong></p>
<p><strong><em>Models.objects.values(‘分组条件列’).annotate(聚合1,聚合2)</em></strong></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#每种年龄中的用户的最大id和用户的最小生日</span></span><br><span class="line"><span class="comment">#select age,max(id),min(birth) from t_user group by age</span></span><br><span class="line">User.objects.values(<span class="string">"age"</span>).annotate(Max(<span class="string">'pk'</span>),Min(<span class="string">'birth'</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#大于18的每种年龄中的用户的最大id和用户的最小生日</span></span><br><span class="line"><span class="comment">#加where : select age,max(id),min(birth) from t_user where age&gt;18 group by age</span></span><br><span class="line">User.objects.values(<span class="string">"age"</span>).filter(age__gt=<span class="number">18</span>).annotate(Max(<span class="string">'pk'</span>),Min(<span class="string">'birth'</span>))</span><br><span class="line"><span class="comment">#也可以写成这样：</span></span><br><span class="line">User.objects.filter(age__gt=<span class="number">18</span>).values(<span class="string">"age"</span>).annotate(mm=Max(<span class="string">'pk'</span>),mi=Min(<span class="string">"birth"</span>))</span><br><span class="line"></span><br><span class="line">having的存在一般用来：对分组的再次条件判断 ＝＝ filter()的条件查询</span><br><span class="line"><span class="comment">#加having : select age,max(id),min(birth) from t_user group by age having max(id)&gt;3</span></span><br><span class="line">User.objects.values(<span class="string">"age"</span>).annotate(Min(<span class="string">'birth'</span>) ,p = Max(<span class="string">'id'</span>)).filter(p__gt=<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#加别名</span></span><br><span class="line">User.objects.values(<span class="string">"age"</span>).filter(age__gt=<span class="number">18</span>).annotate(mm=Max(<span class="string">'pk'</span>),Min(<span class="string">'birth'</span>))</span><br><span class="line"><span class="comment">#加排序：如果涉及到排序，先给字段起个别名，再来排序</span></span><br><span class="line">User.objects.values(<span class="string">"age"</span>).filter(age__gt=<span class="number">18</span>).annotate(mm=Max(<span class="string">'pk'</span>),Min(<span class="string">'birth'</span>)).order_by(<span class="string">'mm'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#补充：</span></span><br><span class="line"><span class="comment">#每个用户的最大id，最小生日 (等价于根据id分组)，这些都是唯一的？</span></span><br><span class="line">User.objects.annotate(mm=Max(<span class="string">'pk'</span>),mi=Min(<span class="string">'birth'</span>))</span><br></pre></td></tr></table></figure>
<p>分组：annotate==一次用：filter()==having</p>
<p>​                                              聚合函数max(),min(),avg(),count(),sum()</p>
<p>​                                              values() == group by的一次综合使用</p>
<p>​                                              mm == as 起别名</p>
<p>QuerySet.query ==返回QuerySet执行的sql语句</p>
<p>User.objects.filter(…).query//可以看到查询语句</p>
<h3 id="F对象和Q对象"><a href="#F对象和Q对象" class="headerlink" title="F对象和Q对象"></a>F对象和Q对象</h3><blockquote>
<p>User.objects.filter(id__gt=1) #id大于1</p>
<p>问题：查询id大于age的用户？  尝试：User.objects.filter(id__gt=age)–错误</p>
<h4 id="当查询条件中需要另外的列时，可以使用F"><a href="#当查询条件中需要另外的列时，可以使用F" class="headerlink" title="当查询条件中需要另外的列时，可以使用F"></a><strong>当查询条件中需要另外的列时，可以使用F</strong></h4><p>User.objects.filter(id__lt=F(‘age’))–正确</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">User.objects.filter(id__lt=F(<span class="string">'age'</span>)) <span class="comment">#id小于age</span></span><br><span class="line">User.objects.filter(id__lt=F(<span class="string">'age'</span>)+<span class="number">1</span>) <span class="comment">#id小于age+1</span></span><br><span class="line">User.objects.filter(id__lt=F(<span class="string">'age'</span>)*<span class="number">10</span>/<span class="number">2</span>) <span class="comment">#id小于age*10/2</span></span><br><span class="line">User.objects.filter(id__lt=F(<span class="string">'age'</span>)+F(<span class="string">'salary'</span>)) <span class="comment">#id小于age+salary</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>User.objects.filter(id__lt=1,name__contains=”zhj”) #id小于1 而且 name包含“zhj”</p>
<p>问题：查询id小于1 或 name含有“zhj”的数据？</p>
<p>​           查询name不含有“zhj”的数据？</p>
<h4 id="当需要-“或-（-）-非（-）”-逻辑时，可以使用Q"><a href="#当需要-“或-（-）-非（-）”-逻辑时，可以使用Q" class="headerlink" title="当需要 “或 （|） 非（~）” 逻辑时，可以使用Q"></a><strong>当需要 “或 （|） 非（~）” 逻辑时，可以使用Q</strong></h4></blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">User.objects.filter(Q(id__gt=<span class="number">3</span>)|Q(id__lt=<span class="number">2</span>)) <span class="comment">#id大于3 或 id小于2</span></span><br><span class="line">User.objects.filter(Q(id__gt=<span class="number">3</span>)|~Q(name__contains=<span class="string">"zhj"</span>)) <span class="comment">#id大于3 或 name不含有“zhj”</span></span><br><span class="line">User.objects.filter(Q(id__lt=<span class="number">3</span>)|Q(age__gt=F(<span class="string">"id"</span>)*<span class="number">10</span>)) <span class="comment">#id小于3 或 age大于id*10</span></span><br><span class="line"></span><br><span class="line">User.objects.filter(Q(id__gt=<span class="number">3</span>)|Q(name__contains=<span class="string">"zhj"</span>)，age__lt=<span class="number">2</span>) <span class="comment">#id大于3 或 name包含"zhj" 且 age小于2</span></span><br><span class="line"></span><br><span class="line">User.objects.filter(Q(id__gt=<span class="number">3</span>)|Q(name__contains=<span class="string">"zhj"</span>)，~Q(age__lt=<span class="number">2</span>) <span class="comment">#id大于3 或 name包含"zhj" 且 age不小于2</span></span><br></pre></td></tr></table></figure>
<h3 id="Raw-SQL"><a href="#Raw-SQL" class="headerlink" title="Raw-SQL"></a>Raw-SQL</h3><blockquote>
<p>如果以上的支持不能满足需求，django也支持直接执行sql语句</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#返回RawQuerySet,其中是一个个的Model对象</span></span><br><span class="line">User.objects.raw(<span class="string">"select id,name from first_app_user3 where id=1"</span>)</span><br><span class="line">User.objects.raw(<span class="string">"select id,name from first_app_user3 where age=%s and name=%s"</span>,[<span class="number">18</span>,<span class="string">"zhj9"</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment">#注意，不要在外部自己拼接sql</span></span><br><span class="line">cc = <span class="string">"select id,name from first_app_user3 where age=%d and name='%s'"</span>%[<span class="number">18</span>,<span class="string">"zhj9"</span>]</span><br><span class="line">User.objects.raw(cc)</span><br><span class="line"><span class="comment">#如上会有sql注入风险：</span></span><br><span class="line">	cc = <span class="string">"select id,name from first_app_user3 where age=%d and name='%s'"</span>%(<span class="number">18</span>,<span class="string">"' or '1'='1"</span>)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>django的QuerySet和Raw-SQL都已经防止了sql注入</p>
</blockquote>
<h1 id="Model-1"><a href="#Model-1" class="headerlink" title="Model"></a>Model</h1><h2 id="关联关系"><a href="#关联关系" class="headerlink" title="关联关系"></a>关联关系</h2><blockquote>
<p>数据库的表之间都是有联系的，正如我们之前讲的，有关联关系的存在</p>
<p>关联关系的种类：1对1 ， 1对多 ， 多对多</p>
<p>在Model中体现关联关系，进而更好的在多表之间操作数据</p>
</blockquote>
<ul>
<li>ForeignKey(to=关系对方的类或类名或‘self’，on_delete=级联选项)</li>
<li>OneToOneFiled(to=关系对方的类或类名或‘self’，on_delete=级联选项)</li>
<li>ManyToManyFiled(to=关系对方的类或类名或‘self’)</li>
</ul>
<blockquote>
<p>级联选项   on_delete=级联删除　</p>
</blockquote>
<ul>
<li>CASCADE  级联删除</li>
<li>SET_NULL  外键置空(如果允许空的话),前提是外键是允许为空的</li>
<li>PROTECT   不允许直接删除主表</li>
<li>SET_DEFAULT  需要为外键列设置默认值，默认值也应该是合法的外键值，可以在表中预留一个id　　（SET==SET_DEFAULT）</li>
<li>SET   将外键设置为某个值，值应该是合法的外键值，可以在表中预留一个id</li>
<li>DO_NOTHING   django什么也不做，由数据库决定是否合法</li>
</ul>
<h3 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>对<span class="number">1</span>关系： Person：没有关系属性   Passport：有关系属性person</span><br><span class="line"><span class="comment">#单独查一方</span></span><br><span class="line">per = Person.objects.all()</span><br><span class="line"><span class="keyword">pass</span> = Passport.objects.all()</span><br><span class="line"></span><br><span class="line"><span class="keyword">pass</span>[<span class="number">0</span>].per  <span class="comment">#通过关系属性名 获取关系对方</span></span><br><span class="line">per[<span class="number">0</span>].passport <span class="comment">#没有关系属性时，通过关系对方全小写的类名，获得对方</span></span><br><span class="line">（per[<span class="number">0</span>].passport这种方法只适用于一对一的表单）</span><br><span class="line"><span class="keyword">pass</span>[<span class="number">0</span>].person.name <span class="comment">#继续获取属性值</span></span><br><span class="line">per[<span class="number">0</span>].passport.note <span class="comment">#继续获取属性值</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#1对1关系：关联查询，会进行表连接</span></span><br><span class="line"><span class="comment">#注意：在查询条件中，如在filter中  passport__note是passport的note字段</span></span><br><span class="line">                                 passport__id是passport的id字段</span><br><span class="line">                                 person__name是person的name字段，</span><br><span class="line"><span class="comment">#护照的note中包含"a"的Person，会做表连接</span></span><br><span class="line">Person.objects.filter(passport__note__contains=<span class="string">"a"</span>)</span><br><span class="line">Person.objects.filter(passport__note=<span class="string">"a"</span>) <span class="comment">##护照的note是"a"的Person，会做表连接</span></span><br><span class="line">Person.objects.filter(passport__id=<span class="number">1</span>)<span class="comment">#护照的id是1的Person，会做表连接</span></span><br><span class="line">Person.objects.filter(passport=<span class="number">1</span>)<span class="comment">#护照的id是1的Person，会做表连接(和上一个等价，只有id可以如此)</span></span><br><span class="line"></span><br><span class="line">Passport.objects.filter(person=<span class="number">1</span>)<span class="comment">#id为1的person的Passport</span></span><br><span class="line">Passport.objects.filter(person__id=<span class="number">1</span>)<span class="comment">#id为1的person的Passport</span></span><br><span class="line">Passport.objects.filter(person__id__gt=<span class="number">1</span>)<span class="comment">#id大于1的person的Passport</span></span><br><span class="line">Passport.objects.filter(person__name__contains=<span class="string">"z"</span>)<span class="comment">#名字中含有'z'的person的Passport</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>对多关系   Category(<span class="number">1</span>)：没有关系属性   Goods(*)：其中有关系属性cate9</span><br><span class="line"><span class="comment">#单独查一方</span></span><br><span class="line">cs = Category.objects.all()</span><br><span class="line">gs = Goods.objects.all()</span><br><span class="line"></span><br><span class="line">cs[<span class="number">0</span>].goods_set <span class="comment"># 没有多方的关系属性，通过"多方类名_set"获得多方</span></span><br><span class="line">                <span class="comment"># 此时只是返回一个RelatedManger，不支持遍历和限制获取子集 而且并没有数据，需要如下</span></span><br><span class="line">cs[<span class="number">0</span>].goods_set.filter(gprice__gt=<span class="number">200</span>) <span class="comment">#第一个类别中价格大于200的所有商品 (如此才有值)</span></span><br><span class="line">cs[<span class="number">0</span>].goods_set.all() <span class="comment"># 第一个类别中的所有商品（如此才有值）</span></span><br><span class="line"></span><br><span class="line">gs[<span class="number">0</span>].cate9 <span class="comment">#获得第一个商品的类别对象</span></span><br><span class="line">gs[<span class="number">0</span>].cate9.ctitle <span class="comment">#获得对象后 自然可以继续获取属性</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#关联查询：会进行表连接</span></span><br><span class="line">cate9是Goods字段中的一个列，查询的结果为该字段属性的所有值</span><br><span class="line">Goods.objects.filter(cate9__gte=<span class="number">1</span>) <span class="comment"># 类别id大于等于1的商品</span></span><br><span class="line">Goods.objects.filter(cate9__pk__gte=<span class="number">1</span>) <span class="comment"># 类别id大于等于1的商品</span></span><br><span class="line">Goods.objects.filter(cate9__id__exact=<span class="number">1</span>)<span class="comment">#类别id等于1的商品</span></span><br><span class="line">Goods.objects.filter(cate9__title__contains=<span class="string">"s"</span>)<span class="comment"># 列名标题含有"s"的商品</span></span><br><span class="line"></span><br><span class="line">Category.objects.filter(goods__gt=<span class="number">1</span>)<span class="comment">#id大于1的商品的类别</span></span><br><span class="line">Category.objects.filter(goods__title__contains=<span class="string">"a"</span>)<span class="comment">#标题中含有"a"的商品的类别</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#注意在进行联合查询时，可能会由重复数据出现，解决：</span></span><br><span class="line">list(set(Category.objects.filter(goods__price__gt=<span class="number">200</span>)))</span><br><span class="line">// 因为在不同类型中有多个价格大于<span class="number">200</span>的产品</span><br><span class="line"><span class="comment">#它的返回值是商品的类，所以它不同的price会对应多个相同的类，所以去重，加list</span></span><br><span class="line"><span class="comment">#转换类型，是为了更好的遍历数据</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">多对多关系   Course：有对方关系属性stus   Student：没有对方关系属性 </span><br><span class="line"><span class="comment">#查询一方</span></span><br><span class="line">stus = Student.objects.all()　　　　　　　　　　　　　　</span><br><span class="line">cours = Course.objects.all()　　　　　　　　　　　　　</span><br><span class="line"></span><br><span class="line">stus[<span class="number">0</span>].course_set <span class="comment">#返回ManyRelatedManager，但并没有数据</span></span><br><span class="line">stus[<span class="number">0</span>].course_set.all() <span class="comment">#获得对方数据</span></span><br><span class="line">stus[<span class="number">0</span>].course_set.filter(title__contains=<span class="string">'s'</span>) <span class="comment">#获得第一个学生的 标题中含有"s"的课程</span></span><br><span class="line"></span><br><span class="line">cours[<span class="number">0</span>].students.all()<span class="comment">#选择了第一个课程的所有学生</span></span><br><span class="line">cours[<span class="number">0</span>].students.filter(age__gt=<span class="number">18</span>)<span class="comment">#选择了第一个课程的所有年龄大于18岁的学生</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#关联查询</span></span><br><span class="line">Student.objects.filter(course__title__contains=<span class="string">"h"</span>) <span class="comment">#标题中含有"h"的课程中的学生</span></span><br><span class="line">Course.objects.filter(students__name=<span class="string">"zzz"</span>) <span class="comment">#姓名为zzz的学生参加的课程</span></span><br><span class="line">Course.objects.filter(students__age__gt=<span class="number">18</span>) <span class="comment">#年龄大于18的学生参加的课程</span></span><br></pre></td></tr></table></figure>
<h3 id="增加"><a href="#增加" class="headerlink" title="增加"></a>增加</h3><blockquote>
<p>单独增加主表方(没有外键一方) 和单表增加无差异</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Category(title=<span class="string">"男装"</span>,...).save()</span><br></pre></td></tr></table></figure>
<blockquote>
<p>为已存在的主表方附加从表数据(常见的增加情形)</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">c = Category.objects.get(pk=<span class="number">1</span>)</span><br><span class="line">c.goods_set.create(title=<span class="string">"zzz6"</span>,price=<span class="number">100</span>) <span class="comment">#不需要再save</span></span><br><span class="line">或</span><br><span class="line">c = Category.objects.get(pk=<span class="number">1</span>)</span><br><span class="line">g=Goods(title=<span class="string">"zzz6"</span>,price=<span class="number">100</span>,cate9=c)<span class="comment">#为商品的关系属性赋值</span></span><br><span class="line">g.save() <span class="comment">#需要save</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>同时增加主从数据</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">g = Goods(title=<span class="string">"zzz6"</span>,price=<span class="number">100</span>)</span><br><span class="line">c = Category(title=<span class="string">"类别1"</span>,note=<span class="string">"xx"</span>)</span><br><span class="line">g.save() <span class="comment">#此时，外键的值为null</span></span><br><span class="line">c.save()</span><br><span class="line">c.goods_set.add(g) <span class="comment">#会同步数据库,补充外键值</span></span><br><span class="line"></span><br><span class="line">或</span><br><span class="line"></span><br><span class="line">c = Category(title=<span class="string">"类别1"</span>,note=<span class="string">"xx"</span>)</span><br><span class="line">c.save()</span><br><span class="line">g = Goods(title=<span class="string">"zzz6"</span>,price=<span class="number">100</span>，cate9=c)</span><br><span class="line">g.save() <span class="comment">#此时，good是有外键值得</span></span><br></pre></td></tr></table></figure>
<h3 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h3><blockquote>
<p>单独删除从表方，和删除单表无差异</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Goods.objects.get(pk=<span class="number">1</span>).delete()</span><br></pre></td></tr></table></figure>
<blockquote>
<p>删除主表方，此时要看从表方的级联设置，会影响到从表方</p>
<p>(在所有的有关联的表中，如果直接删除从表，则是简单的删除即可，如果要是删除主表，则从表也会跟着从表类的外联属性设置值，而变化)</p>
<p>1:1 支持CASCADE       SET_NULL(前提:外键列允许为null)      </p>
<p>1:*  都支持</p>
<p>*:*  不支持级联删除</p>
<p>（如果是OneToOneField可以用on_delete=”CASCADE”，也可用SET_NULL,null=true）null的默认值必须是为空的</p>
<p>(on_delete:级联属性，当删除主表行时，从表的对应行的关系)（属性设置）</p>
<p>(CASCADE:对应的从表行也会随着删除，一般考虑到数据的宝贵性，建议不使用它)</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#如果要删除主，所有从的外键置null  （重要）</span></span><br><span class="line">per = models.OneToOneField(to=Person,on_delete=models.SET_NULL,null=<span class="literal">True</span>)</span><br><span class="line"><span class="comment">#如果要删除主，所有从一起删除</span></span><br><span class="line">per = models.OneToOneField(to=Person,on_delete=models.CASCADE,null=<span class="literal">True</span>)</span><br><span class="line"><span class="comment">#如果要删除主，django什么也不做，有数据库决定是否合法</span></span><br><span class="line">per = models.OneToOneField(to=Person,on_delete=models.DO_NOTHING,null=<span class="literal">True</span>)</span><br><span class="line"><span class="comment">#如果要删除主，所有从的外键置为6  （重要）</span></span><br><span class="line"> (SET(<span class="number">6</span>),设置的对应默认值，一般是主表存在，专用于被删除的列)</span><br><span class="line">cate115 = models.ForeignKey(to=<span class="string">"Category"</span>,on_delete=models.SET(<span class="number">6</span>))</span><br><span class="line"><span class="comment">#如果要删除主，所有从的外键置为默认值5 （重要）（默认的值不一定要求主已经存在的）</span></span><br><span class="line">   （设置的默认值必须是有一个models.SET(),设置的外键值是主键已经存在的）</span><br><span class="line">cate115 = models.ForeignKey(to=<span class="string">"Category"</span>,on_delete=models.SET_DEFALUT,default=<span class="string">"5"</span>)</span><br><span class="line"><span class="comment">#如果要删除主，如果有从数据存在，不允许删除</span></span><br><span class="line">cate115 = models.ForeignKey(to=<span class="string">"Category"</span>,on_delete=models.PROTECT)</span><br></pre></td></tr></table></figure>
<h3 id="修改"><a href="#修改" class="headerlink" title="修改"></a>修改</h3><blockquote>
<p>查询出数据，修改属性，然后save()即可</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cs = Category.objects.all()</span><br><span class="line">c = cs[<span class="number">0</span>]</span><br><span class="line">c.title=<span class="string">"new_title"</span></span><br><span class="line">c.save()</span><br><span class="line"></span><br><span class="line">坑：</span><br><span class="line">Category.objects.all()[<span class="number">0</span>].title=<span class="string">"new_title"</span>  <span class="comment">#查询一次，并修改</span></span><br><span class="line">Category.objects.all()[<span class="number">0</span>].save() <span class="comment">#查询一次，并保存</span></span><br></pre></td></tr></table></figure>
<h2 id="QuerySet-高级特性：懒加载-Lazy-load"><a href="#QuerySet-高级特性：懒加载-Lazy-load" class="headerlink" title="QuerySet 高级特性：懒加载  Lazy-load"></a>QuerySet 高级特性：懒加载  Lazy-load</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a = Person.objects.all()</span><br><span class="line">b = Category.objects.all()</span><br><span class="line">print(a)</span><br><span class="line"><span class="comment">#如上代码只执行了一次</span></span><br><span class="line">所谓的QuerySet的懒加载：就是当数据在需要的使用的时候，它才会去加载，否则会一直不执行filter,all,(返回的是一个QuerySet对象)get(pk=id)返回的是object对象</span><br></pre></td></tr></table></figure>
<blockquote>
<p>测试方式</p>
<p>找到mysql的安装目录下的my.ini文件，添加配置：</p>
<p>在cmd下net stop mysql  </p>
<p>​               net start mysql</p>
<p>在搜索框中输入fuwu</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; [mysqld]</span><br><span class="line">&gt; .....</span><br><span class="line">&gt; log = <span class="string">"E:/mysql_log.sql"</span> <span class="comment">#设置日志文件，记录sql语句执行</span></span><br><span class="line">&gt; 或</span><br><span class="line">&gt; general-log=<span class="number">1</span></span><br><span class="line">&gt; general_log_file=E:/mysql_log.sql</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/django model operator.md/" data-id="cjwm7iw150005kov9d7iccqc9" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/git-flow.md/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">git-flow</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/django model operator.md/">django model operator</a>
          </li>
        
          <li>
            <a href="/git-flow.md/">git-flow</a>
          </li>
        
          <li>
            <a href="/git use.md/">git use</a>
          </li>
        
          <li>
            <a href="/linux生产环境搭建.md/">linux生产环境搭建</a>
          </li>
        
          <li>
            <a href="/hello-world.md/">Hello World</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>